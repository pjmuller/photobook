<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Album - v5: Data-Driven & Event Delegation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/split.js/dist/split.min.js"></script>
    <style>
        /* CSS is identical to Version 1 */
        body { background-color: #333; color: #fff; overflow-x: hidden; }
        .album-container { display: flex; width: 100%; padding: 20px; box-sizing: border-box; }
        .page { aspect-ratio: 35 / 29; width: 50%; display: flex; flex-direction: column; background-color: #1a1a1a; border: 2px solid #555; }
        .page-row { display: flex; }
        .cell { position: relative; overflow: hidden; background-color: #000; border: 1px solid #444; }
        /* Data attributes are used to store state directly on the DOM */
        .cell img { position: absolute; width: 100%; height: 100%; object-fit: cover; cursor: grab; user-select: none; will-change: transform; transform: scale(1) translate(0px, 0px); }
        .cell img:active { cursor: grabbing; }
        .controls { position: absolute; bottom: 5px; left: 5px; right: 5px; z-index: 10; display: flex; align-items: center; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 5px; opacity: 0; transition: opacity 0.3s; }
        .cell:hover .controls { opacity: 1; }
        .controls input[type="range"] { width: 100%; }
        .gutter { background-color: #555; }
        .gutter.gutter-horizontal { cursor: ns-resize; height: 10px; }
        .gutter.gutter-vertical { cursor: ew-resize; width: 10px; }
    </style>
</head>
<body>
    <div class="container-fluid text-center p-3">
        <h1>Photo Album - Version 5: Data-Driven & Event Delegation</h1>
        <p class="text-muted">Album is generated from a JS array. One event listener manages all cells for max efficiency.</p>
    </div>
    <!-- The album starts empty. JS will build everything. -->
    <div id="album-container" class="album-container"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- Data Source ---
    const imageData = Array.from({ length: 12 }, (_, i) => `https://picsum.photos/800/600?random=${i + 1}`);

    // --- Dynamic Album Generation ---
    function buildAlbum(containerId, data) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
            <div class="page" id="page-left">
                <div class="page-row" id="page-left-row1"></div>
                <div class="page-row" id="page-left-row2"></div>
            </div>
            <div class="page" id="page-right">
                <div class="page-row" id="page-right-row1"></div>
                <div class="page-row" id="page-right-row2"></div>
            </div>
        `;
        
        const rows = container.querySelectorAll('.page-row');
        data.forEach((src, index) => {
            const rowIndex = Math.floor(index / 3);
            const cell = document.createElement('div');
            cell.className = 'cell';
            // Store initial state on data attributes
            cell.dataset.zoom = '1';
            cell.dataset.tx = '0';
            cell.dataset.ty = '0';

            cell.innerHTML = `
                <img src="${src}" alt="Random image">
                <div class="controls">
                    <input type="range" class="zoom-slider" min="1" max="5" step="0.1" value="1">
                </div>
            `;
            rows[rowIndex].appendChild(cell);
        });
    }

    buildAlbum('album-container', imageData);

    // --- Gutter Initialization ---
    Split(['#page-left > .page-row', '#page-right > .page-row'], {
        direction: 'vertical', sizes: [50, 50], minSize: 100, gutterSize: 10,
    });
    
    document.querySelectorAll('.page-row').forEach(row => {
        Split(Array.from(row.children), {
            sizes: [33.3, 33.3, 33.3], minSize: 50, gutterSize: 10,
        });
    });

    // --- Event Delegation Logic ---
    const albumContainer = document.getElementById('album-container');
    let activeDragState = null; // Holds state for the currently dragged image

    function updateTransform(cell, zoom, tx, ty) {
        const img = cell.querySelector('img');
        
        // Constraint logic (same as Vanilla JS version)
        const imgRect = img.getBoundingClientRect();
        const cellRect = cell.getBoundingClientRect();
        const maxPanX = (imgRect.width * zoom - cellRect.width) / 2 / zoom;
        const maxPanY = (imgRect.height * zoom - cellRect.height) / 2 / zoom;
        const clampedX = Math.max(-maxPanX, Math.min(maxPanX, tx));
        const clampedY = Math.max(-maxPanY, Math.min(maxPanY, ty));

        img.style.transform = `scale(${zoom}) translate(${clampedX}px, ${clampedY}px)`;
        cell.dataset.tx = clampedX; // Update state on the DOM
        cell.dataset.ty = clampedY;
    }

    // SINGLE mousedown listener for the whole album
    albumContainer.addEventListener('mousedown', (e) => {
        // Only act if an image inside a cell was clicked
        if (!e.target.matches('.cell img')) return;

        e.preventDefault();
        const cell = e.target.closest('.cell');
        e.target.style.cursor = 'grabbing';
        
        activeDragState = {
            cell: cell,
            startX: e.clientX,
            startY: e.clientY,
            initialTx: parseFloat(cell.dataset.tx),
            initialTy: parseFloat(cell.dataset.ty),
            zoom: parseFloat(cell.dataset.zoom)
        };
    });

    // SINGLE mousemove listener on the window
    window.addEventListener('mousemove', (e) => {
        if (!activeDragState) return;

        const { cell, startX, startY, initialTx, initialTy, zoom } = activeDragState;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        const newTx = initialTx + (dx / zoom);
        const newTy = initialTy + (dy / zoom);

        updateTransform(cell, zoom, newTx, newTy);
    });

    // SINGLE mouseup listener
    window.addEventListener('mouseup', () => {
        if (!activeDragState) return;
        activeDragState.cell.querySelector('img').style.cursor = 'grab';
        activeDragState = null;
    });

    // SINGLE input listener for all zoom sliders
    albumContainer.addEventListener('input', (e) => {
        if (!e.target.matches('.zoom-slider')) return;
        
        const cell = e.target.closest('.cell');
        const zoom = parseFloat(e.target.value);
        cell.dataset.zoom = zoom;
        
        updateTransform(cell, zoom, parseFloat(cell.dataset.tx), parseFloat(cell.dataset.ty));
    });
});
</script>
</body>
</html>