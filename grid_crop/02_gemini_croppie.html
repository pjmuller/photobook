<!-- works well, only temporary glitch while resizing the gutters, you see some croppie artefacts  -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resizable Photo Album (Croppie.js - Corrected)</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    
    <!-- Croppie.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Custom Styles -->
    <style>
        body {
            background-color: #f0f2f5;
            font-family: sans-serif;
        }

        /* --- Album Layout & Aspect Ratio --- */
        #album-container {
            position: relative;
            width: 100%;
            padding-bottom: calc(100% * 29 / 70); /* (35+35):29 aspect ratio */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            background-color: #333;
        }

        #album-content {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            gap: 10px; /* Center spine */
            padding: 10px;
        }

        .page {
            width: 50%; height: 100%;
            background-color: #fff;
            display: flex;
            flex-direction: column;
        }

        .row-split { display: flex; flex-direction: row; }
        .cell { position: relative; overflow: hidden; background-color: #e9ecef; }
        
        /* --- Split.js Gutter Styling --- */
        .gutter {
            background-color: #fff;
            background-repeat: no-repeat;
            background-position: center;
        }
        .gutter.gutter-vertical {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="30"><path d="M0,14.5 H10 M0,15.5 H10" stroke="%23888" stroke-width="1"/></svg>');
            cursor: row-resize;
            height: 10px;
        }
        .gutter.gutter-horizontal {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="30" height="10"><path d="M14.5,0 V10 M15.5,0 V10" stroke="%23888" stroke-width="1"/></svg>');
            cursor: col-resize;
            width: 10px;
        }

        /* --- Croppie.js Overrides & Slider Styling --- */
        .cell .cr-boundary {
            /* Ensure the boundary fills the cell completely */
            width: 100% !important;
            height: 100% !important;
        }

        .cell .cr-slider-wrap {
            /* Style the slider container to be visible and well-positioned */
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            padding: 5px 10px;
            margin: 0;
        }
        
        .cell .cr-slider {
            /* Ensure the slider input fills its container */
            width: 100%;
            margin: 0;
        }
    </style>
</head>
<body>

    <main class="container-fluid my-4">
        <h1 class="text-center mb-4">Resizable Photo Album (Croppie.js - Corrected)</h1>
        <div id="album-container">
            <div id="album-content">
                <!-- Data attributes are used to track image IDs and instances -->
                <div id="page-left" class="page">
                    <div class="row-split">
                        <div class="cell" data-image-id="1"></div><div class="cell" data-image-id="2"></div><div class="cell" data-image-id="3"></div>
                    </div>
                    <div class="row-split">
                        <div class="cell" data-image-id="4"></div><div class="cell" data-image-id="5"></div><div class="cell" data-image-id="6"></div>
                    </div>
                </div>
                <div id="page-right" class="page">
                    <div class="row-split">
                        <div class="cell" data-image-id="7"></div><div class="cell" data-image-id="8"></div><div class="cell" data-image-id="9"></div>
                    </div>
                    <div class="row-split">
                        <div class="cell" data-image-id="10"></div><div class="cell" data-image-id="11"></div><div class="cell" data-image-id="12"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JS Libraries CDN -->
    <script src="https://unpkg.com/split.js/dist/split.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Main Application Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let croppieInstances = [];

            /**
             * A utility function to delay execution of a function.
             * This prevents the resize handler from firing too frequently.
             */
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            /**
             * Creates a new Croppie instance for a given cell.
             */
            function createCroppieForCell(cell, initialState = null) {
                const rect = cell.getBoundingClientRect();
                if (rect.width < 10 || rect.height < 10) return; // Don't init on tiny/hidden cells

                const imageId = cell.dataset.imageId;
                const imageUrl = `https://picsum.photos/seed/${imageId}/800/600`;

                const croppie = new Croppie(cell, {
                    viewport: { width: rect.width, height: rect.height },
                    boundary: { width: rect.width, height: rect.height },
                    showZoomer: true, // Enable the zoom slider
                    enableOrientation: true,
                    mouseWheelZoom: 'ctrl'
                });

                const bindOptions = { url: imageUrl };
                if (initialState?.points) {
                    bindOptions.points = initialState.points;
                }

                croppie.bind(bindOptions).then(() => {
                    if (initialState?.zoom) {
                        croppie.setZoom(initialState.zoom);
                    }
                });

                croppieInstances.push({ cell, instance: croppie });
            }

            /**
             * This is the core logic. It destroys all instances, then recreates them
             * in their new dimensions, preserving the user's crop and zoom settings.
             */
            function updateAllCroppies() {
                const states = croppieInstances.map(({ instance }) => instance.get());
                
                croppieInstances.forEach(({ instance }) => instance.destroy());
                croppieInstances = []; // Clear the old array

                document.querySelectorAll('.cell').forEach((cell, index) => {
                    createCroppieForCell(cell, states[index]);
                });
            }

            // --- Initial Setup ---
            document.querySelectorAll('.cell').forEach(cell => createCroppieForCell(cell));

            // Create a debounced version of our update function.
            // This will be called by split.js's onDrag event and the window resize event.
            const debouncedUpdateHandler = debounce(updateAllCroppies, 150);

            // --- Initialize Split.js ---
            ['#page-left', '#page-right'].forEach(pageId => {
                const pageElement = document.querySelector(pageId);
                const rows = Array.from(pageElement.children).filter(el => el.classList.contains('row-split'));
                Split(rows, {
                    direction: 'vertical',
                    sizes: [50, 50],
                    minSize: 100,
                    gutterSize: 10,
                    onDrag: debouncedUpdateHandler, // Call the debounced handler on drag
                });
            });

            document.querySelectorAll('.row-split').forEach(rowElement => {
                const cells = Array.from(rowElement.children).filter(el => el.classList.contains('cell'));
                Split(cells, {
                    direction: 'horizontal',
                    sizes: [33.33, 33.33, 33.33],
                    minSize: 100,
                    gutterSize: 10,
                    onDrag: debouncedUpdateHandler, // Call the debounced handler on drag
                });
            });

            // Also update on window resize using the same debounced handler
            window.addEventListener('resize', debouncedUpdateHandler);
        });
    </script>
</body>
</html>